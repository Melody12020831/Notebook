---
statistics: True
comments: true
---

# Chapter 5 | 运输层

## 运输层概述

### 进程间基于网络的通信

第2~4章依次介绍了计算机网络体系结构中的物理层、数据链路层和网络层，它们共同解决了将主机通过异构网络互联起来所面临的问题，实现了**主机到主机**的通信。

然而在计算机网络中实际进行通信的真正实体，是位于**通信两端主机中的进程**。

如何**为运行在不同主机上的应用进程提供直接的逻辑通信服务**，就是**运输层的主要任务**。运输层协议又称为**端到端**协议。

![img](./assets/5-1.png)

![img](./assets/5-2.png)

注意：这里的“端口”并不是看得见、摸得着的物理端口，而是用来区分不同应用进程的标识符。

运输层向应用层实体屏蔽了下面网络核心的细节（例如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就**好像是在两个运输层实体之间有一条端到端的逻辑通信信道**。

根据应用需求的不同，**因特网的运输层**为应用层提供了两种不同的运输层协议，即**面向连接的TCP**和**无连接的UDP**。

---

### TCP/IP运输层中的两个重要协议

![img](./assets/5-3.png)

---

#### **TCP**

传输控制协议（Transmission Control Protocol，TCP）为其上层提供的是面向连接的**可靠**的数据传输服务。

使用TCP通信的双方，在传送数据之前必须**首先建立TCP连接**（逻辑连接，而非物理连接）。数据传输结束后**必须要释放TCP连接**。

TCP为了实现可靠传输，就必须使用很多措施，例如**TCP连接管理、确认机制、超时重传、流量控制以及拥塞控制**等。

TCP的**实现复杂**，TCP报文段的**首部比较大**，占用处理机**资源比较多**。

---

#### **UDP**

用户数据报协议（User Datagram Protocol，UDP）为其上层提供的是**无连接**的**不可靠**的数据传输服务。

使用UDP通信的双方，在传送数据之前不需要建立连接。

UDP不需要实现可靠传输，因此不需要使用实现可靠传输的各种机制。

UDP的**实现简单**，UDP用户数据报的**首部比较小**。

![img](./assets/5-7.png)

---

### 运输层端口号

运行在计算机上的进程是使用**进程标识符**（Process Identification，**PID**）来标识的。

- 然而，因特网上的计算机并不是使用统一的操作系统，而**不同操作系统**（Windows、Linux、MacOS）又使用**不同格式的进程标识符**。
- 为了使运行不同操作系统的计算机的应用进程之间能够基于网络进行通信，就必须使用**统一**的方法对TCP/IP体系的应用进程进行标识。

TCP/IP体系结构的运输层使用**端口号**来标识和区分应用层的不同应用进程。端口号的长度为16比特，取值范围是0~65535。

![img](./assets/5-4.png)

端口号只具有本地意义，即端口号只是为了标识本计算机网络协议栈应用层中的各应用进程。在因特网中，不同计算机中的相同端口号是没有关系的，即相互独立。另外，TCP和UDP端口号之间也是没有关系的。

---

### 发送方的复用和接收方的分用

![img](./assets/5-5.png)

![img](./assets/5-6.png)

**发送方的复用** (Multiplexing at Sender)

**复用**是指发送方不同的应用进程都可以使用同一个传输层协议（TCP 或 UDP）来传送数据。这就像许多不同的人（应用进程）都通过同一个邮局（传输层）来寄信。

流程如下：

1. **应用层产生数据：** 各种应用层进程（红色方块）生成应用报文。
2. **端口映射：** 每个应用进程通过特定的 **端口 (Port)** 将数据传递给传输层。端口号就是用来区分不同应用进程的标识。
3. **传输层复用 (UDP/TCP复用)：**

* **UDP复用：** 多个应用进程的数据块被封装成 UDP 用户数据报。
* **TCP复用：** 多个应用进程的数据流被封装成 TCP 报文段。
* 传输层会在头部加上 **源端口** 和 **目的端口**，以便接收方知道是谁发的、发给谁。

4. **IP 复用：** 这是网络层的复用。无论是 UDP 用户数据报还是 TCP 报文段，最终都会被送到 IP 层，封装成 **IP 数据报** 发送出去。

* **关键标识：** 为了让接收方知道这个 IP 数据报里装的是 UDP 还是 TCP，IP 首部中有一个 **协议字段 (Protocol Field)**。

* 如果值为 **17**，表示数据部分是 UDP。
* 如果值为 **6**，表示数据部分是 TCP。

**接收方的分用** (Demultiplexing at Receiver)

**分用**是复用的逆过程。它是指接收方的传输层在剥去报文首部后，能够根据首部中的信息，把数据正确地交付给目的应用进程。

流程如下：

1. **IP 分用：**

* 接收方收到 IP 数据报后，IP 层首先检查 **协议字段值**。
* 如果协议字段是 **17**，IP 层就把数据部分上交给 **UDP 分用** 处理。
* 如果协议字段是 **6**，IP 层就把数据部分上交给 **TCP 分用** 处理。

2. **传输层分用 (UDP/TCP分用)：**

* UDP 或 TCP 协议收到数据后，会检查首部中的 **目的端口号**。
* 根据端口号，传输层找到对应的应用进程（例如端口 80 对应 Web 服务，端口 53 对应 DNS）。

3.  **交付应用：** 最终，应用报文被准确地投递给目标应用进程（红色方块）。

---

## UDP和TCP的对比

### 无连接的UDP和面向连接的TCP

“连接”指逻辑连接关系，而不是物理连接。

![img](./assets/5-8.png)

---

### UDP和TCP对单播、多播和广播的支持情况

![img](./assets/5-9.png)

---

### UDP和TCP应用层报文的处理

![img](./assets/5-10.png)

---

### UDP和TCP对数据传输可靠性的支持情况

![img](./assets/5-11.png)

---

### UDP首部和TCP首部的对比

![img](./assets/5-12.png)

---

## TCP报文段的首部格式

![img](./assets/5-13.png)

- **序号**: 占32比特，取值范围为 0 ~ $2^{32}-1$ 。当序号增加到最后一个时，下一个序号又回到0。用来指出本TCP报文段数据载荷的第一个字节的序号。
- **确认号**: 占32比特，取值范围为 0 ~ $2^{32}-1$ 。当确认号增加到最后一个时，下一个确认号又回到0。用来指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认。
- **确认标志位ACK**: 当ACK标志位置1时，确认号字段有效。ACK取值为0时，确认号字段无效。TCP规定：在TCP连接建立后，所有传送的TCP报文段都必须把ACK置1。

??? example "PPT上例题"
    ![img](./assets/5-14.png)

    ![img](./assets/5-15.png)

    ![img](./assets/5-16.png)

- **数据偏移**: 占4比特，该字段的取值以4字节为单位。指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远，这实际上指出了TCP报文段的首部长度。

![img](./assets/5-17.png)

- **保留**: 占6比特，保留供将来使用，当前必须置0。
- **窗口**: 占16比特，该字段的取值以字节为单位。指出发送本报文段的一方的接收窗口的大小，即接收缓存的可用空间大小，这用来表征接收方的接收能力。在计算机网络中，经常用接收方的接收能力的大小来控制发送方的数据发送量，这就是所谓的流量控制。
- **检验和**: 占16比特。用来检查整个TCP报文段在传输过程中是否出现了误码。

---