---
statistics: True
comments: true
---

# Chapter 4 | 网络层

## 网络层概述

### 分组转发和路由选择

网络层的主要任务就是将分组**从源主机经过多个网络和多段链路传输到目的主机**，可以将该任务划分为**分组转发**和**路由选择**两种重要的功能。

![img](./assets/4-1.png)

> R1如何知道应从自己的哪个接口转发分组？
> 
> R1通过查阅自己的**转发表**来决定分组的转发接口。转发表中列出了到达各个目的地的路径信息，包括目的地地址前缀、下一跳路由器地址以及应使用的接口等。
> 
> 转发表如何得来？
> 
> 路由器通过**路由选择算法**来动态地构建和维护路由表。路由选择算法根据网络拓扑结构、链路状态和其他因素，计算出到达各个目的地的最佳路径，并将这些路径信息存储在路由表中。转发表则是路由表的一部分，专门用于指导分组的转发。
> 
> 路由表又如何得来？
> 
> 路由表可以通过**静态配置**或**动态路由协议**来获得。静态配置是由网络管理员手动设置的，而动态路由协议（如RIP、OSPF、BGP等）则允许路由器自动交换路由信息，动态更新路由表。
>
> ![img](./assets/4-2.png)
> 
> 转发表是地图，路由选择算法是导航系统，路由表是导航系统中的路线数据库。
> 
> 总的来说，路由表是根据路由选择算法得出的，而转发表是从路由表得出的。转发表的结构应使查找过程最优化，路由表则需要最优化网络拓扑变化的计算。在讨论路由选择的原理时，往往不区分转发表和路由表，而笼统地使用路由表一词。


??? note "中继系统分类"
    1. 物理层中继系统:转发器，集线器
    
    2. 数据链路层中继系统:网桥或交换机。
    
    3. 网络层中继系统:路由器。
    
    4. 网络层以上的中继系统:网关。

???+ example
    在路由器互连的多个局域网的结构中，要求每个局域网( )。
    
    A.物理层协议可以不同，而数据链路层及其以上的高层协议必须相同
    
    B.物理层、数据链路层协议可以不同，而数据链路层以上的高层协议必须相同
    
    C.物理层、数据链路层、网络层协议可以不同，而网络层以上的高层协议必须相同
    
    D.物理层、数据链路层、网络层及高层协议都可以不同

??? note "answer"
    C

    路由器是第三层设备，向传输层及以上层隐藏下层的具体实现，所以物理层、数据链路层、网络层协议可以不同。而网络层之上的协议数据是路由器所不能处理的，因此网络层以上的高层协议必须相同。本题容易误选 B，主要原因是在目前的互联网中广泛使用的是 TCP/IP 族，在网络层用的多是IPv4,所以误认为网络层协议必须相同。实际上，使用特定的路由器连接 IPv4 与 PPv6网络，就是典型的网络层协议不同而实现互连的例子。

---

### 网络层向其上层提供的两种服务

- 面向连接的虚电路服务
- 无连接的数据报服务

---

#### 面向连接的虚电路服务

核心思想是“**可靠通信应由网络自身来保证**”。

必须首先建立**网络层连接**—— **虚电路**（Virtual Circuit，VC），以保证通信双方所需的一切网络资源。

通信双方**沿着已建立的虚电路发送分组**。

- 虚电路表示这是一条逻辑上的连接，分组沿着这条逻辑连接按照存储转发方式传送，而不是真正建立了一条物理连接。
- 而采用电路交换的电话通信，则是先建立一条真正的物理连接。因此，分组交换的虚连接与电路交换的连接只是类似，但并不完全一样。
- 分组的首部仅在连接建立阶段使用完整的目的主机地址，之后每个分组的首部只需要携带一条虚电路编号即可。

通信结束后，需要**释放**之前所建立的虚电路。

![img](./assets/4-3.png)

这种通信方式如果再使用**可靠传输的网络协议**，就可使所发送的分组最终正确（无差错按序到达、不丢失、不重复）到达接收方。

很多广域分组交换网都使用面向连接的虚电路服务。例如，曾经的X.25和逐渐过时的帧中继（Frame Relay，FR）、异步传输模式（Asynchronnous Transfer Mode，ATM）。

然而，因特网的先驱者并没有采用这种设计思想，而是采用了无连接的数据报服务。

---

#### 无连接的数据报服务

核心思想是“**可靠通信应由用户主机来保证**”。

**不需要建立网络层连接。**

**每个分组可走不同的路径。**因此，每个分组的首部都必须携带目的主机的完整地址。

通信结束后，**没有需要释放的连接**。

![img](./assets/4-4.png)

这种通信方式所传送的分组可能**误码、丢失、重复和失序**。

所以:

- 将复杂的网络处理功能置于因特网的边缘（即用户主机和其内部的运输层）
- 将相对简单的尽最大努力（即不可靠）的分组交付功能置于因特网核心。

由于网络自身不提供端到端的可靠传输服务，这就使得网络中的路由器可以做得比较简单，大大降低了网络造价。

另外，这种设计思想的运行方式灵活、能够适应多种应用。因特网能够发展到今日的规模，充分证明了当初采取这种设计思想的正确性。

那么对于 TCP/IP体系结构来说，网际层可以提供简单灵活的、无连接的不可靠的数据报服务。

![img](./assets/4-5.png)

???+ example
    路由器在能够开始向输出链路传输分组的第一位之前，必须先接收到整个分组，这种机制称为()。
    
    A.存储转发机制  B.直通交换机制  C.分组交换机制   D.分组检测机制

??? note "answer"
    A

    路由器转发一个分组的过程如下:先接收整个分组，然后对分组进行错误检查，若出错，则丢弃错误的分组:否则存储这个正确的分组。最后根据路由选择协议，将正确的分组转发到合适的端口，这种机制称为存储转发机制。

    分组交换机制：泛指网络层采用分组方式进行数据交换，不特指分组的转发方式。

???+ example
    下列关于虚电路和数据报的叙述中，正确的是()。
    
    A.虚电路是一种分组交换技术，但不能按照存储转发的方式工作
    
    B.虚电路的连接是临时性连接，当会话结束时就释放这种连接
    
    C.数据报服务不提供可靠传输，但可以保证分组的有序到达
    
    D.数据报服务中，每个分组都必须携带源地址和目的地址

??? note "answer"
    D

    虚电路是一种分组交换技术，它可以采用存储转发的方式工作，选项A错误。虚电路不只是临时性的，它提供的服务包括永久性虚电路(PVC)和交换型虚电路(SVC)，其中前者是一种提前定义好的、基本上不需要任何建立时间的端点之间的连接,而后者是端点之间的一种临时性连接,这些连接只持续所需的时间，且在会话结束时就取消这种连接，选项B错误。数据报服务是无连接的，既不提供可靠性保障，又不保证分组的有序到达，选项C错误。在数据报服务中，每个分组都必须携带源地址和目的地址;而虚电路服务中，建立连接后，分组只需携带虚电路标识。

---

## 网际协议（IP）

### 异构网络互连

#### 网际协议IP

网际协议（Internet Protocol，IP）是TCP/IP体系结构**网际层中的核心协议**。

网际协议IP、传输控制协议TCP、TCP/IP体系结构是由“因特网之父” Robert Kalm 和 Vint Cerf 二人共同研发的，1974年5月发布了TCP/IP的第一个版本。

---

#### 异构网络互连

![img](./assets/4-6.png)

要将众多的异构型网络都互连起来，并且能够互相通信，则会面临许多需要解决的问题。不同的网络接入机制、不同的差错恢复方法、不同的路由选择技术、不同的寻址方案、不同的最大分组长度、不同的服务（面向连接服务和无连接服务）。

这些网络的拓扑、性能以及所使用的网络协议都不尽相同，这是由用户需求的多样性造成的，**没有一种单一的网络**能够适应所有用户的需求。

当IP网上的主机进行通信时，就好像在一个单个网络上通信一样，它们看不见互连的各网络的具体异构细节。

---

### IPv4地址及其编址方法

#### IPv4地址概述

IPv4地址是给因特网（Internet）上的**每一个主机（或路由器）的每一个接口**分配的一个在全世界范围内**唯一的32比特的标识符**。

??? note "something about 唯一(MAC & IPv4)"
    MAC地址唯一：MAC地址是网卡的物理地址，用于局域网内设备识别。唯一性保证同一网络内不会有地址冲突，数据能准确送达目标设备。

    IPv4地址唯一：IPv4地址是网络层的逻辑地址，用于全球范围内设备通信。唯一性保证因特网中每个主机都能被正确定位和访问。

    还有什么是**唯一**的？

    - 端口号（在同一主机上）：用于区分同一IP下不同应用进程。

    - 域名（全球唯一）：用于人类友好访问网站，DNS系统保证唯一。

    - UUID（通用唯一标识符）：用于软件、数据库等场景唯一标识对象。

    - 设备序列号：硬件厂商分配，用于唯一标识设备。

![img](./assets/4-7.png)

IPv4地址由**因特网名字和数字分配机构**（Internet Corporation for Assigned Names and Numbers，ICANN）进行分配。

- 我国用户可向**亚太网络信息中心**（Asia Pacific Network Information Center，APNIC）申请IP地址，需要缴纳相应的费用，一般不接受个人申请。
- 2011年2月3日，因特网号码分配管理局（Internet Assigned Numbers Authority，IANA）（由ICANN行使职能）宣布，IPv4地址已经分配完毕。
- 我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6。

IPv4地址的编址方法经历了三个历史阶段：

![img](./assets/4-8.png)

??? note "具体解释"
    1. 分类编址（Classful Addressing）

    最早的IPv4地址分配方法，将IP地址分为A、B、C、D、E五类（主要用A/B/C）。

    类地址有固定的网络号和主机号长度。例如：

    - A类：网络号8位，主机号24位，适合大型网络

    - B类：网络号16位，主机号16位

    - C类：网络号24位，主机号8位，适合小型网络

    优点：简单，易于实现。

    缺点：地址利用率低，容易造成浪费。例如一个单位可能只需要几十个主机，却被分配了一个C类地址（最多支持254主机）。

    2. 划分子网（Subnetting）

    为了提高地址利用率，引入了子网划分的概念。

    在原有的网络号和主机号之间，增加了“子网号”字段。

    网络管理员可以根据实际需求，把一个网络进一步划分为多个子网，每个子网有自己的主机号范围。

    优点：灵活分配地址，便于网络管理和扩展。

    缺点：依然受限于分类编址的结构，不能彻底解决地址浪费问题。

    3. 无分类编址（Classless Addressing，CIDR）

    1993年提出无分类域间路由（CIDR），彻底消除了分类编址和子网划分的概念。

    IP地址不再固定分为A/B/C类，而是用“前缀长度”来表示网络部分和主机部分（如192.168.1.0/24）。

    地址分配更加灵活，可以根据实际需要分配任意数量的地址块。

    优点：极大提高了地址利用率、支持更高效的路由聚合（路由表更小）、适应互联网规模快速增长。

    CIDR成为现代IPv4地址分配和路由的标准方法。

---

#### IPv4地址的表示方法

由于IPv4地址由32比特构成，不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制**表示方法以方便用户使用。

- 把32位二进制数每8位分为一组，共4组。每组称为一个“字节”（octet）。
- 每组8位二进制数转换为十进制数。四个十进制数之间用“.”分隔。

![img](./assets/4-9.png)

??? note "PPT 上的练习"
    ![img](./assets/4-10.png)

??? note "转换方式"
    **8位无符号二进制整数转十进制数**

    ![img](./assets/4-11.png)

    ![img](./assets/4-12.png)

    **十进制正整数转8位无符号二进制数**

    ![img](./assets/4-13.png)

---

### IPv4地址的分类编址方法

**网络号**: 

- 标志主机（或路由器）的接口所连接到的**网络**
- **同一个网络中**，**不同**主机（或路由器）的**接口**的IPv4地址的**网络号必须相同**，表示它们属于同一个网络。

**主机号**:

- 标志主机（或路由器）的**接口**
- **同一个网络中**，**不同**主机（或路由器）的**接口**的IPv4地址的**主机号必须各不相同**，以便区分各主机（或路由器）的接口。

![img](./assets/4-14.png)

![img](./assets/4-15.png)

- **A类**、**B类**和**C类**地址都是**单播地址**，只有单播地址可以**分配给网络中的主机（或路由器）的各接口**。
- **主机号为“全0”**的地址是**网络地址**，**不能分配**给主机（或路由器）的各接口。
- **主机号为“全1”**的地址是**广播地址**，**不能分配**给主机（或路由器）的各接口。

---

#### A类地址

![img](./assets/4-16.png)

最小网络号为0，表示本网络，不能分配给实际网络使用。

最小可指派网络号为1，网络地址为 1.0.0.0。

最大网络号为127，作为本地环回测试地址，不能指派配给实际网络使用。

- 最小的本地环回测试地址为127.0.0.1
- 最大的本地环回测试地址为127.255.255.254

最大可指派的网络号为126，网络地址为 126.0.0.0。

可指派的 A 类网络数量为 $2^{7}-2=126$ 个。**（减2是去掉最小网络号0和最大网络号127）**

每个 A 类网络中可分配的地址数量为 $2^{24}-2=16,777,214$ 个。**（减2是去掉主机号为全0的网络地址和全1的广播地址）**

---

#### B类地址

![img](./assets/4-17.png)

最小可指派的网络号为128.0，网络地址为 128.0.0.0。

最大可指派的网络号为191.255，网络地址为 191.255.0.0。

可指派的 B 类网络数量为 $2^{16-2}=16,384$ 个。

每个 B 类网络中可分配的地址数量为 $2^{16}-2=65,534$ 个。

---

#### C类地址

![img](./assets/4-18.png)

最小可指派的网络号为192.0.0，网络地址为 192.0.0.0。

最大可指派的网络号为223.255.255，网络地址为 223.255.255.0。

可指派的 C 类网络数量为 $2^{24-2}=2,097,152$ 个。

每个 C 类网络中可分配的地址数量为 $2^{8}-2=254$ 个。

![img](./assets/4-19.png)

??? note "为什么 B 和 C 类地址没有本网络和本地环回测试地址？"
    B类和C类的环回测试和本地网络功能都统一用A类的127和0来实现。这大概是历史遗留问题。

??? note "PPT 上的练习"
    ![img](./assets/4-20.png)

![img](./assets/4-21.png)

??? note "PPT 上的练习"
    ![img](./assets/4-22.png)

    ![img](./assets/4-23.png)

---

### IPv4地址的划分子网编址方法

随着更多的中小网络加入因特网，**IPv4分类编址方法不够灵活**、**容易造成大量IPv4地址资源浪费的缺点**就暴露出来了。

![img](./assets/4-24.png)

还剩余大量地址：只能由该单位的同一个网络使用，而其他单位的网络不能使用。

![img](./assets/4-25.png)

申请新的网络号存在以下弊端：

- 需要等待很长的时间，并且要花费更多的费用。
- 即便申请到了两个新的网络号，其他路由器的路由表还需要新增针对这两个新的网络的路由条目。
- 浪费原来已申请到的B类网络中剩余的大量地址。

如果可以从IPv4地址的主机号部分借用一些比特作为子网号来区分不同的子网，就可以利用原有网络中剩余的大量IPv4地址，而不用申请新的网络地址了。

![img](./assets/4-26.png)

借用16比特主机号中的前8个比特作为子网号。

> 如果未在图中标记子网号部分，那么我们或计算机又如何知道在分类地址中，主机号有多少比特被借用作为子网号了呢？

**子网掩码**可以表明分类IPv4地址的主机号部分被借用了几个比特作为子网号。

与IPv4地址类似，子网掩码也是由**32比特**构成的。

- 用左起多个**连续的比特1**对应IPv4地址中的**网络号**和**子网号**；
- 之后的多个**连续的比特0**对应IPv4地址中的**主机号**。

将划分子网的**IPv4地址与相应的子网掩码**进行逐比特的**逻辑与运算**，就可**得到**该IPv4地址所在**子网的网络地址**。

![img](./assets/4-27.png)

**只要给定了一个分类的IPv4地址及其相应的子网掩码，就可以得出子网划分的全部细节。**

已知某个网络的地址为 `218.75.230.0` ，使用子网掩码 `255.255.255.128` 对其进行子网划分，请给出划分细节。

![img](./assets/4-29.png)

![img](./assets/4-30.png)

![img](./assets/4-31.png)

??? note "PPT 上的练习"
    ![img](./assets/4-28.png)

    ![img](./assets/4-32.png)

    ![img](./assets/4-33.png)

**默认子网掩码**是指在**未划分子网的情况下使用的子网掩码**。

![img](./assets/4-34.png)

---

### IPv4地址的无分类编址方法

IPv4地址的划分子网编址方法在一定程度上缓解了因特网在发展中遇到的困难，但是**数量巨大的C类网**($2^{24-3} =2097152$个)由于其每个网络所包含的地址数量太小($2^{8}-2=254$个)，因此**并没有得到充分使用**，而因特网的IPv4地址仍在加速消耗，**整个IPv4地址空间面临全部耗尽的威胁**。

为此，因特网工程任务组IETF又提出了采用**无分类编址**的方法，来解决IPv4地址资源紧张的问题，同时还专门成立IPv6工作组负责研究新版本的IP，以彻底解决IPv4地址耗尽问题。

1993年，因特网工程任务组IETF发布了**无分类域间路由选择**（Classless Inter-Domain Routing，**CIDR** ）的RFC文档[RFC1517~1519，RFC1520]。

- **CIDR消除了传统A类、B类和C类地址以及划分子网的概念。**
- **CIDR可以更加有效地分配IPv4地址资源，并且可以在IPv6使用之前允许因特网的规模继续增长。**

![img](./assets/4-35.png)

无分类编址方法使用的**地址掩码**与划分子网使用的**子网掩码**类似，由32比特构成。

- 用左起多个**连续的比特1**对应IPv4地址中的**网络前缀**；
- 之后的多个**连续的比特0**对应IPv4地址中的**主机号**。

??? note "举例"
    ![img](./assets/4-36.png)

    为了简便起见，可以不明确给出配套的地址掩码的点分十进制形式，而是在无分类编址的IPv4地址后面加上斜线“/”，在斜线之后写上网络前缀所占的比特数量（也就是地址掩码中左起连续比特1的数量），这种记法称为**斜线记法**。

    ![img](./assets/4-37.png)

实际上，无分类域间路由选择CIDR是将网络前缀都相同的、连续的多个无分类IPv4地址，组成一个**CIDR地址块**，只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的以下全部细节：

- 地址块中的**最小地址**
- 地址块中的**最大地址**
- 地址块中的**地址数量**
- 地址块中**聚合某类网络（A类、B类、C类）的数量**
- **地址掩码**

??? note "PPT 上的练习"
    ![img](./assets/4-38.png)

    一个C类网络有256个地址（ $2^{8}=256$ ），即主机号8位。

    该CIDR地址块的地址数量是 $2^{32-20}=4096$ （主机号12位）。

    所以，该CIDR地址块**聚合了16个C类网络**（ $4096/256=16$ ）。

    ![img](./assets/4-39.png)

使用无分类编址方法，可以根据客户的需要**分配适当大小的CIDR地址块**，因此可以更加有效地分配IPv4的地址空间。

![img](./assets/4-40.png)

使用无分类编址方法的另一个好处是**路由聚合**（也称为**构造超网**）。

- 网络前缀越长，地址块越小，路由越具体；
- 若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为**最长前缀匹配**，因为这样的路由更具体。

![img](./assets/4-41.png)

??? note "PPT 上的练习"
    ![img](./assets/4-42.png)

    ![img](./assets/4-43.png)

---

## 静态路由配置

---

## 因特网的路由选择协议

---

## 网际控制报文协议

---

## 虚拟专用网和网络地址转换

---

## IP多播

---

## 移动IP技术

---

## 下一代网际协议IPv6

---

## 软件定义网络

---